
<!-- –ó–∞—Ä–ø–ª–∞—Ç–Ω—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä -->
<!-- –ó–∞—Ä–ø–ª–∞—Ç–Ω—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä -->
<div id="salary-section">
    <div id="header-container">
        <h2 class="salary-title">üí∞ –†–∞—Å—á–µ—Ç –∑–∞—Ä–ø–ª–∞—Ç</h2>
        <button onclick="openSalaryReport()" class="yellow-btn">üìÑ –û—Ç—á—ë—Ç –ø–æ –∑–∞—Ä–ø–ª–∞—Ç–∞–º</button>
    </div>

    <div id="staff-list" class="staff-grid"></div>

    <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
    <div class="staff-card add-manual-card" onclick="openManualSalaryForm()">
        <div class="staff-name">‚ûï</div>
        <div class="staff-role">–î–æ–±–∞–≤–∏—Ç—å –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞</div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—Ç—á–µ—Ç–∞ -->
<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –∑–∞—Ä–ø–ª–∞—Ç—ã -->
<div id="salary-modal" class="modal">
    <!-- –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫—Ä–µ—Å—Ç–∏–∫ (–æ—Å—Ç–∞–µ—Ç—Å—è –Ω–∞ –º–µ—Å—Ç–µ –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ) -->
    <button class="modal-close" onclick="closeSalaryModal()">‚úï</button>

    <div class="salary-modal-content">
        <!-- –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç - –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–π –∫—Ä–µ—Å—Ç–∏–∫ -->
        <!-- <button class="modal-close-sticky" onclick="closeSalaryModal()">‚úï</button> -->

        <div class="salary-header">
            <img id="modal-staff-skin" class="modal-staff-skin" src="" alt="–°–∫–∏–Ω">
            <div class="modal-staff-info">
                <h3 id="modal-staff-name"></h3>
                <p id="modal-staff-role"></p>
            </div>
            <div class="month-selector">
                <select id="salary-month" class="month-select" onchange="updateOnlineHours(document.getElementById('nickname').value)">
                    <option value="current">–¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü</option>
                    <option value="previous" selected>–ü—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü</option>
                </select>
            </div>
        </div>

<!-- –§–æ—Ä–º–∞ —Ä–∞—Å—á–µ—Ç–∞ -->
<div class="salary-form">
    <input type="hidden" id="nickname">

    <!-- –ö–æ–ª–æ–Ω–∫–∞ 1 -->
    <div class="form-group">
        <label>–í—Ä–µ–º—è –æ–Ω–ª–∞–π–Ω–∞ (—á–∞—Å—ã)</label>
        <input type="number" id="online_hours" class="input-field" min="0">
    </div>
    <div class="form-group">
        <label>–ñ–∞–ª–æ–±—ã</label>
        <input type="number" id="complaints" class="input-field" min="0">
    </div>
    <div class="form-group">
        <label>–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã</label>
        <input type="number" id="attached_moderators" class="input-field" min="0">
    </div>

    <!-- –ö–æ–ª–æ–Ω–∫–∞ 2 -->
    <div class="form-group">
        <label>–¢–æ–ø –ø–æ –æ–Ω–ª–∞–π–Ω—É (1-3 –∏–ª–∏ –ø—É—Å—Ç–æ)</label>
        <input type="number" id="online_top" class="input-field" min="1" max="3">
    </div>
    <div class="form-group" id="severe_complaints_group">
        <label>–ñ–∞–ª–æ–±—ã –Ω–∞ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤</label>
        <input type="number" id="severe_complaints" class="input-field" min="0">
    </div>
    <div class="form-group">
        <label>–†–µ—Ü–µ–Ω–∑–∏—è –æ—Ç –ì–ú–ê</label>
        <input type="number" id="gma_review" class="input-field" min="0">
    </div>

    <!-- –ö–æ–ª–æ–Ω–∫–∞ 3 -->
    <div class="form-group">
        <label>–í–æ–ø—Ä–æ—Å-–æ—Ç–≤–µ—Ç</label>
        <input type="number" id="questions" class="input-field" min="0">
    </div>
    <div class="form-group" id="interviews_group">
        <label>–°–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è</label>
        <input type="number" id="interviews" class="input-field" min="0">
    </div>
    <div class="form-group">
        <label>–¢–æ–ø –ø–æ –≤–æ–ø—Ä–æ—Å–∞–º (1-3 –∏–ª–∏ –ø—É—Å—Ç–æ)</label>
        <input type="number" id="questions_top" class="input-field" min="1" max="3">
    </div>

    <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
    <div class="form-actions">
        <button onclick="calculateStaffSalary()" class="calculate-btn">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
        <button id="confirm-salary" onclick="confirmSalary()" class="action-btn confirm-btn" style="display:none;">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button id="send-telegram" onclick="sendToTelegram()" class="action-btn send-btn" style="display:none;">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram</button>
    </div>
</div>

        <div id="salary-result" class="salary-result"></div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—Ç—á–µ—Ç–∞ -->
<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—Ç—á–µ—Ç–∞ -->
<div id="report-modal" class="modal-container">
    <button onclick="closeModal('report-modal')" class="action-btn-cancel-btn">‚úï</button>

    <div class="modal-content">

        <h2>üìä –û—Ç—á—ë—Ç –ø–æ –∑–∞—Ä–ø–ª–∞—Ç–∞–º</h2>

        <div class="report-controls">
            <label for="report-month">üìÖ –ú–µ—Å—è—Ü:</label>
            <select id="report-month" onchange="refreshSalaryReport()" class="report-select">
                <option value="current">–¢–µ–∫—É—â–∏–π</option>
                <option value="previous">–ü—Ä–æ—à–ª—ã–π</option>
            </select>

        </div>

        <div class="styled-table-container">
            <table id="salary-report-table" class="styled-table">
                <thead>
                    <tr>
                        <th>–ù–∏–∫</th>
                        <th>–†–æ–ª—å</th>
                        <th>–û–Ω–ª–∞–π–Ω</th>
                        <th>–í–æ–ø—Ä–æ—Å—ã</th>
                        <th>–ñ–∞–ª–æ–±—ã</th>
                        <th>–ñ–±. –°—Ç.</th>
                        <th>–ü—Ä–∏–∫—Ä.</th>
                        <th>–°–æ–±–µ—Å—ã</th>
                        <th>–¢–æ–ø –û–Ω–ª–∞–π–Ω</th>
                        <th>–¢–æ–ø –í–æ–ø—Ä–æ—Å—ã</th>
                        <th>–†–µ—Ü–µ–Ω–∑–∏—è</th>
                        <th>–ó–∞—Ä–ø–ª–∞—Ç–∞</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div style="text-align: center; margin-top: 25px; padding-top: 20px; border-top: 1px solid rgba(255, 215, 0, 0.2);">
            <button onclick="sendSalaryReportToTelegram()" class="action-btn send-btn">
                üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram
            </button>
        </div>
    </div>
</div>

<script>
    function openSalaryModal(nickname, role) {
    const modal = document.getElementById('salary-modal');
    const staffName = document.getElementById('modal-staff-name');
    const staffRole = document.getElementById('modal-staff-role');
    const staffSkin = document.getElementById('modal-staff-skin');
    const nicknameInput = document.getElementById('nickname');

    staffName.textContent = nickname;
    staffRole.textContent = role;

    // –ü–æ–ª—É—á–∞–µ–º project_name –¥–ª—è —Å–∫–∏–Ω–∞
    const projectName = document.querySelector('meta[name="project-name"]').getAttribute('content');
    staffSkin.src = `https://meta-api.metalabs.work/api/v3/users/skins/${projectName}/head/${nickname}`;

    nicknameInput.value = nickname;

    // –°–∫—Ä—ã–≤–∞–µ–º/–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏
    const severeComplaintsGroup = document.getElementById('severe_complaints_group');
    const interviewsGroup = document.getElementById('interviews_group');

    if (role === '–ö—É—Ä–∞—Ç–æ—Ä' || role === '–ì–ª.–º–æ–¥–µ—Ä–∞—Ç–æ—Ä' || role === '–°—Ç.–º–æ–¥–µ—Ä–∞—Ç–æ—Ä') {
        severeComplaintsGroup.style.display = 'block';
        interviewsGroup.style.display = 'block';
    } else {
        severeComplaintsGroup.style.display = 'none';
        interviewsGroup.style.display = 'none';
        document.getElementById('severe_complaints').value = '';
        document.getElementById('interviews').value = '';
    }

    clearSalaryForm();
    updateOnlineHours(nickname);
    modal.classList.add('show'); // –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏
}

function closeSalaryModal() {
    document.getElementById('salary-modal').classList.remove('show');
}

function openSalaryReport() {
    document.getElementById("report-modal").classList.add("show");
    refreshSalaryReport();
}

function closeModal(id) {
    document.getElementById(id).classList.remove("show");
}

    async function refreshSalaryReport() {
    const project = projectName;
    const server = serverName;
    const monthSelect = document.getElementById('report-month');
    const selectedMonth = monthSelect.value;

    const date = new Date();
    let month, year;
    if (selectedMonth === 'current') {
        month = (date.getMonth() + 1).toString().padStart(2, '0');
        year = date.getFullYear();
    } else {
        month = (date.getMonth() === 0 ? 12 : date.getMonth()).toString().padStart(2, '0');
        year = date.getMonth() === 0 ? date.getFullYear() - 1 : date.getFullYear();
    }

    const monthStr = `${year}-${month}`;

    const response = await fetch("/get_salaries", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ project, server, month: monthStr })
    });

        const salaries = await response.json();
        const tbody = document.querySelector("#salary-report-table tbody");
        tbody.innerHTML = "";

        if (!salaries || !salaries.length) {
            tbody.innerHTML = `<tr><td colspan="13">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–µ—Å—è—Ü</td></tr>`;
            return;
        }

        salaries.forEach(s => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td contenteditable="true">${s.nickname}</td>
                <td contenteditable="true">${s.role}</td>
                <td contenteditable="true">${s.online_hours}</td>
                <td contenteditable="true">${s.questions}</td>
                <td contenteditable="true">${s.complaints}</td>
                <td contenteditable="true">${s.severe_complaints}</td>
                <td contenteditable="true">${s.attached_moderators}</td>
                <td contenteditable="true">${s.interviews}</td>
                <td contenteditable="true">${s.online_top ?? ""}</td>
                <td contenteditable="true">${s.questions_top ?? ""}</td>
                <td contenteditable="true">${s.gma_review ?? ""}</td>
                <td contenteditable="true">${s.total_salary}</td>
                <td>
                    <button onclick="deleteSalary('${s.nickname}', '${s.project}', '${s.server}', '${s.month}', this)">üóë</button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    async function deleteSalary(nickname, project, server, month, buttonElement) {
        const confirmed = confirm(`–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å ${nickname}?`);
        if (!confirmed) return;

        const res = await fetch("/delete_salary", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ nickname, project, server, month })
        });

        const result = await res.json();
        if (result.success) {
            showNotification("–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞");

            // –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –∏–∑ DOM
            const row = buttonElement.closest("tr");
            if (row) row.remove();
        } else {
            showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏");
        }
    }



    function openManualSalaryForm() {
        const modal = document.getElementById('salary-modal');
        const staffName = document.getElementById('modal-staff-name');
        const staffRole = document.getElementById('modal-staff-role');
        const staffSkin = document.getElementById('modal-staff-skin');
        const nicknameInput = document.getElementById('nickname');

        // –°–±—Ä–æ—Å –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞
        clearSalaryForm();

        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–∏–∫
        const nickname = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞ (–ü–°–ñ):");
        if (!nickname) return;

        staffName.textContent = nickname;
        staffRole.textContent = "–ü–°–ñ";
        staffSkin.src = `https://meta-api.metalabs.work/api/v3/users/skins/{{ project_name }}/head/${nickname}`;
        nicknameInput.value = nickname;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –ø–æ–ª—è
        document.getElementById('severe_complaints_group').style.display = 'block';
        document.getElementById('interviews_group').style.display = 'block';

        modal.classList.add('show');
    }
    // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞

function closeModal(id) {
    document.getElementById(id).classList.remove("show"); // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å, —á—Ç–æ–±—ã —Å–∫—Ä—ã—Ç—å –æ–∫–Ω–æ
}
</script>
