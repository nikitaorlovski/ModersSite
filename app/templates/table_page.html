<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–∞–±–ª–∏—Ü–∞ –¥–∞–Ω–Ω—ã—Ö –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤ - {{ project_name }} | {{ server_name }}</title>
    <style>
        /* –ú–ò–ù–ò–ú–ê–õ–¨–ù–´–ï –°–¢–ò–õ–ò –¢–û–õ–¨–ö–û –î–õ–Ø –¢–ê–ë–õ–ò–¶–´ */
        body {
            margin: 0;
            padding: 20px;
            background: #1c1c2e;
            color: white;
            font-family: 'Inter', sans-serif;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #FFD700;
        }

        .header h1 {
            color: #FFD700;
            margin: 0 0 10px 0;
        }

        .server-info {
            color: #ccc;
            font-size: 1.1rem;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
            align-items: center;
        }

        .controls select, .controls button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 6px;
            color: white;
            padding: 8px 15px;
            cursor: pointer;
        }

        .controls button {
            background: #4CAF50;
        }

        .table-container {
            overflow-x: auto;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            overflow: hidden;
        }

        th {
            background: rgba(255, 215, 0, 0.2);
            color: #FFD700;
            padding: 15px 12px;
            text-align: center;
            font-weight: 600;
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
        }

        td {
            padding: 12px 10px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.03);
            color: white;
        }

        .nickname-cell {
            font-weight: 600;
            color: #FFD700;
            text-align: left;
            padding-left: 15px;
        }

        input {
            width: 70px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            color: #FFD700;
            padding: 6px;
            text-align: center;
        }

        .save-btn {
            background: #4CAF50;
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 215, 0, 0.9);
            border: none;
            color: #1c1c2e;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥ -->
    <a href="/server/{{ project_name }}/{{ server_name }}" class="back-btn">‚Üê –ù–∞–∑–∞–¥</a>

    <div class="header">
        <h1>üìä –¢–∞–±–ª–∏—Ü–∞ –¥–∞–Ω–Ω—ã—Ö –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤</h1>
        <div class="server-info">
            –ü—Ä–æ–µ–∫—Ç: <strong>{{ project_name }}</strong> | –°–µ—Ä–≤–µ—Ä: <strong>{{ server_name }}</strong>
        </div>
    </div>

    <div class="controls">
        <label>–ú–µ—Å—è—Ü:</label>
        <select id="table-month" onchange="loadTableData()">
            <option value="current">–¢–µ–∫—É—â–∏–π</option>
            <option value="previous">–ü—Ä–æ—à–ª—ã–π</option>
        </select>
        <button onclick="saveAllTableData()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ</button>
        <button onclick="loadTableData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>

    <div class="table-container">
        <table id="staff-table">
            <thead>
                <tr>
                    <th>–ù–∏–∫</th>
                    <th>–û–Ω–ª–∞–π–Ω</th>
                    <th>–í–æ–ø—Ä–æ—Å—ã</th>
                    <th>–ñ–∞–ª–æ–±—ã</th>
                    <th>–ñ–±. –°—Ç</th>
                    <th>–ü—Ä–∏–∫—Ä.</th>
                    <th>–°–æ–±–µ—Å—ã</th>
                    <th>–¢–æ–ø –æ–Ω–ª–∞–π–Ω</th>
                    <th>–¢–æ–ø –≤–æ–ø—Ä–æ—Å—ã</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody id="table-body">
                <tr>
                    <td colspan="10" style="text-align: center; padding: 40px;">
                        üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <script>
        // –ü–†–û–°–¢–û–ô JS –î–õ–Ø –¢–ê–ë–õ–ò–¶–´
        let currentTableData = [];

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–∞–±–ª–∏—Ü—É...');
            loadTableData();
        });

        async function loadTableData() {
            try {
                const projectName = "{{ project_name }}";
                const serverName = "{{ server_name }}";
                const monthSelect = document.getElementById('table-month');
                const selectedMonth = monthSelect.value;

                const date = new Date();
                let month, year;
                if (selectedMonth === 'current') {
                    month = (date.getMonth() + 1).toString().padStart(2, '0');
                    year = date.getFullYear();
                } else {
                    month = (date.getMonth() === 0 ? 12 : date.getMonth()).toString().padStart(2, '0');
                    year = date.getMonth() === 0 ? date.getFullYear() - 1 : date.getFullYear();
                }

                const monthStr = `${year}-${month}`;

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
                const tbody = document.getElementById('table-body');
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px;">üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td></tr>';

                // –ü–æ–ª—É—á–∞–µ–º –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤
                const staffResponse = await fetch('/get_staff');
                const staffData = await staffResponse.json();

                if (!staffData.body?.users) {
                    throw new Error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤');
                }

                // –ü–æ–ª—É—á–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                let savedData = [];
                try {
                    const tableResponse = await fetch(`/get_table_data?project=${encodeURIComponent(projectName)}&server=${encodeURIComponent(serverName)}&month=${encodeURIComponent(monthStr)}`);
                    if (tableResponse.ok) {
                        savedData = await tableResponse.json();
                    }
                } catch (e) {
                    console.log('–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö');
                }

                // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                const savedDataMap = {};
                savedData.forEach(item => {
                    savedDataMap[item.nickname] = item;
                });

                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤
                const moderators = Object.entries(staffData.body.users)
                    .sort((a, b) => {
                        const roleOrder = {
                            'group.curator': 1, 'group.grandmoderator': 2, 'group.stmoderator': 3,
                            'group.moder': 4, 'group.helper': 5, 'group.stajer': 6
                        };
                        return (roleOrder[a[1]] || 999) - (roleOrder[b[1]] || 999);
                    });

                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–∞–±–ª–∏—Ü—É
                tbody.innerHTML = '';
                currentTableData = [];

                moderators.forEach(([nickname, role]) => {
                    const saved = savedDataMap[nickname] || {};

                    const rowData = {
                        nickname: nickname,
                        project: projectName,
                        server: serverName,
                        month: monthStr,
                        online_hours: saved.online_hours || 0,
                        questions: saved.questions || 0,
                        complaints: saved.complaints || 0,
                        severe_complaints: saved.severe_complaints || 0,
                        attached_moderators: saved.attached_moderators || 0,
                        interviews: saved.interviews || 0,
                        online_top: saved.online_top || '',
                        questions_top: saved.questions_top || ''
                    };

                    currentTableData.push(rowData);

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="nickname-cell">${nickname}</td>
                        <td><input type="number" value="${rowData.online_hours}" data-field="online_hours" data-nickname="${nickname}"></td>
                        <td><input type="number" value="${rowData.questions}" data-field="questions" data-nickname="${nickname}"></td>
                        <td><input type="number" value="${rowData.complaints}" data-field="complaints" data-nickname="${nickname}"></td>
                        <td><input type="number" value="${rowData.severe_complaints}" data-field="severe_complaints" data-nickname="${nickname}"></td>
                        <td><input type="number" value="${rowData.attached_moderators}" data-field="attached_moderators" data-nickname="${nickname}"></td>
                        <td><input type="number" value="${rowData.interviews}" data-field="interviews" data-nickname="${nickname}"></td>
                        <td><input type="number" value="${rowData.online_top}" data-field="online_top" data-nickname="${nickname}" min="1" max="3" placeholder="-"></td>
                        <td><input type="number" value="${rowData.questions_top}" data-field="questions_top" data-nickname="${nickname}" min="1" max="3" placeholder="-"></td>
                        <td><button class="save-btn" onclick="saveRowData('${nickname}')">üíæ</button></td>
                    `;
                    tbody.appendChild(row);
                });

                console.log(`‚úÖ –¢–∞–±–ª–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞: ${moderators.length} –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤`);

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                document.getElementById('table-body').innerHTML =
                    `<tr><td colspan="10" style="text-align: center; color: red; padding: 40px;">
                        ‚ùå –û—à–∏–±–∫–∞: ${error.message}
                    </td></tr>`;
            }
        }

        async function saveRowData(nickname) {
    const rowData = currentTableData.find(row => row.nickname === nickname);
    if (!rowData) return;

    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö —Ç–∏–ø–∞—Ö
    const dataToSend = {
        nickname: String(rowData.nickname),
        project: String(rowData.project),
        server: String(rowData.server),
        month: String(rowData.month),
        online_hours: Number(rowData.online_hours) || 0,
        questions: Number(rowData.questions) || 0,
        complaints: Number(rowData.complaints) || 0,
        severe_complaints: Number(rowData.severe_complaints) || 0,
        attached_moderators: Number(rowData.attached_moderators) || 0,
        interviews: Number(rowData.interviews) || 0,
        online_top: rowData.online_top === '' ? null : Number(rowData.online_top),
        questions_top: rowData.questions_top === '' ? null : Number(rowData.questions_top)
    };

    console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:', dataToSend);

    try {
        const response = await fetch('/save_table_data', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(dataToSend)
        });

        if (response.ok) {
            alert(`‚úÖ –î–∞–Ω–Ω—ã–µ –¥–ª—è ${nickname} —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã`);
        } else {
            const error = await response.text();
            throw new Error(error);
        }
    } catch (error) {
        alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
    }
}
// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –ø–æ–ª—è—Ö –≤–≤–æ–¥–∞
document.addEventListener('input', function(event) {
    if (event.target.tagName === 'INPUT') {
        const field = event.target.dataset.field;
        const nickname = event.target.dataset.nickname;
        const value = event.target.value;

        // –ù–∞—Ö–æ–¥–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å –≤ currentTableData
        const rowData = currentTableData.find(row => row.nickname === nickname);
        if (rowData) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –¥–∞–Ω–Ω—ã—Ö
            if (field === 'online_top' || field === 'questions_top') {
                rowData[field] = value === '' ? '' : Number(value);
            } else {
                rowData[field] = Number(value) || 0;
            }

            console.log(`–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${nickname}.${field} = ${value}`);
        }
    }
});

        async function saveAllTableData() {
    try {
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
        const dataToSend = currentTableData.map(rowData => ({
            nickname: String(rowData.nickname),
            project: String(rowData.project),
            server: String(rowData.server),
            month: String(rowData.month),
            online_hours: Number(rowData.online_hours) || 0,
            questions: Number(rowData.questions) || 0,
            complaints: Number(rowData.complaints) || 0,
            severe_complaints: Number(rowData.severe_complaints) || 0,
            attached_moderators: Number(rowData.attached_moderators) || 0,
            interviews: Number(rowData.interviews) || 0,
            online_top: rowData.online_top === '' ? null : Number(rowData.online_top),
            questions_top: rowData.questions_top === '' ? null : Number(rowData.questions_top)
        }));

        console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ (–≤—Å–µ):', dataToSend);

        const response = await fetch('/save_table_data_batch', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(dataToSend)
        });

        if (response.ok) {
            alert('‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
        } else {
            throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
        }
    } catch (error) {
        alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
    }
}
    </script>
</body>
</html>